---
description: 
globs: 
alwaysApply: false
---
# AIä¾¦æ¢æ¨ç†æ¸¸æˆ API æ¥å£æ–‡æ¡£

## ğŸ“‹ ç›®å½•
- [åŸºç¡€ä¿¡æ¯](mdc:#åŸºç¡€ä¿¡æ¯)
- [å‰ç«¯é¡µé¢æ¥å£](mdc:#å‰ç«¯é¡µé¢æ¥å£)
- [æ¸¸æˆæ ¸å¿ƒæ¥å£](mdc:#æ¸¸æˆæ ¸å¿ƒæ¥å£)
- [æ•°æ®æŸ¥è¯¢æ¥å£](mdc:#æ•°æ®æŸ¥è¯¢æ¥å£)
- [ç®¡ç†å‘˜æ¥å£](mdc:#ç®¡ç†å‘˜æ¥å£)
- [ç³»ç»Ÿæ¥å£](mdc:#ç³»ç»Ÿæ¥å£)
- [æ•°æ®æ¨¡å‹](mdc:#æ•°æ®æ¨¡å‹)
- [é”™è¯¯ç è¯´æ˜](mdc:#é”™è¯¯ç è¯´æ˜)

## ğŸŒ åŸºç¡€ä¿¡æ¯

**Base URL**: `http://localhost:8000`  
**Content-Type**: `application/json`  
**æ—¶åŒºé…ç½®**: æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡ `TIMEZONE` é…ç½®ï¼Œé»˜è®¤ä¸º `Asia/Shanghai`

---

## ğŸ¨ å‰ç«¯é¡µé¢æ¥å£

### 1. ä¸»é¡µ
```http
GET /
```
**è¯´æ˜**: è¿”å›æ¸¸æˆä¸»é¡µé¢  
**å“åº”**: HTMLé¡µé¢

### 2. æ¸¸æˆå†å²é¡µé¢
```http
GET /game_history.html
```
**è¯´æ˜**: è¿”å›æ¸¸æˆå†å²è®°å½•é¡µé¢  
**å“åº”**: HTMLé¡µé¢

### 3. æ¸¸æˆè¯„ä»·é¡µé¢
```http
GET /evaluation.html
```
**è¯´æ˜**: è¿”å›æ¸¸æˆè¯„ä»·é¡µé¢  
**å“åº”**: HTMLé¡µé¢

### 4. æ¸¸æˆå›æ”¾é¡µé¢
```http
GET /replay.html
```
**è¯´æ˜**: è¿”å›æ¸¸æˆå›æ”¾é¡µé¢  
**å“åº”**: HTMLé¡µé¢  
**æŸ¥è¯¢å‚æ•°**: 
- `session_id`: æ¸¸æˆä¼šè¯ID

### 5. æµå¼æµ‹è¯•é¡µé¢
```http
GET /test_stream.html
```
**è¯´æ˜**: è¿”å›æµå¼å“åº”æµ‹è¯•é¡µé¢ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰  
**å“åº”**: HTMLé¡µé¢

---

## ğŸ® æ¸¸æˆæ ¸å¿ƒæ¥å£

### 1. è·å–æ¡ˆä¾‹åˆ—è¡¨
```http
GET /api/cases
```
**è¯´æ˜**: è·å–æ‰€æœ‰å¯ç”¨çš„æ¸¸æˆæ¡ˆä¾‹  
**æŸ¥è¯¢å‚æ•°**:
- `category` (å¯é€‰): æ¡ˆä¾‹åˆ†ç±»ç­›é€‰
- `difficulty` (å¯é€‰): éš¾åº¦ç­›é€‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "cases": [
    {
      "id": 0,
      "title": "ç¥ç§˜çš„å›¾ä¹¦é¦†å‘½æ¡ˆ",
      "description": "ä¸€ä¸ªå®‰é™çš„å¤œæ™šï¼Œå›¾ä¹¦é¦†å‘ç”Ÿäº†ä»¤äººéœ‡æƒŠçš„å‘½æ¡ˆ...",
      "category": "murder",
      "difficulty": "medium",
      "estimated_time": "30-45åˆ†é’Ÿ"
    }
  ]
}
```

### 2. è·å–åˆ†ç±»ä¿¡æ¯
```http
GET /api/categories
```
**è¯´æ˜**: è·å–æ¡ˆä¾‹åˆ†ç±»å’Œéš¾åº¦é€‰é¡¹  

**å“åº”ç¤ºä¾‹**:
```json
{
  "categories": [
    {"value": "murder", "name": "è°‹æ€æ¡ˆ"},
    {"value": "theft", "name": "ç›—çªƒæ¡ˆ"}
  ],
  "difficulties": [
    {"value": "easy", "name": "ç®€å•"},
    {"value": "medium", "name": "ä¸­ç­‰"},
    {"value": "hard", "name": "å›°éš¾"}
  ]
}
```

### 3. å¼€å§‹æ¸¸æˆ
```http
POST /api/game/start
```
**è¯´æ˜**: å¼€å§‹æ–°çš„æ¸¸æˆä¼šè¯  

**è¯·æ±‚ä½“**:
```json
{
  "case_index": 0,
  "client_id": "optional_client_identifier"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "session_id": "uuid-string",
  "case_title": "ç¥ç§˜çš„å›¾ä¹¦é¦†å‘½æ¡ˆ",
  "current_round": 1,
  "max_rounds": 30,
  "hints_used": 0,
  "max_hints": 3,
  "characters": [...],
  "conversation_history": {}
}
```

### 4. è·å–æ¸¸æˆçŠ¶æ€
```http
GET /api/game/{session_id}/state
```
**è¯´æ˜**: è·å–æŒ‡å®šä¼šè¯çš„å½“å‰æ¸¸æˆçŠ¶æ€  

**è·¯å¾„å‚æ•°**:
- `session_id`: æ¸¸æˆä¼šè¯ID

### 5. æé—®ï¼ˆæµå¼å“åº”ï¼‰
```http
POST /api/game/question/stream
```
**è¯´æ˜**: å‘è§’è‰²æé—®å¹¶è·å–æµå¼å“åº”  

**è¯·æ±‚ä½“**:
```json
{
  "session_id": "uuid-string",
  "character_name": "è§’è‰²åç§°",
  "question": "ä½ çš„é—®é¢˜"
}
```

**å“åº”**: Server-Sent Events (SSE) æµå¼æ•°æ®

### 6. æé—®ï¼ˆæ™®é€šå“åº”ï¼‰
```http
POST /api/game/question
```
**è¯´æ˜**: å‘è§’è‰²æé—®å¹¶è·å–å®Œæ•´å“åº”  

**è¯·æ±‚ä½“**: åŒä¸Š

**å“åº”ç¤ºä¾‹**:
```json
{
  "character_name": "è§’è‰²åç§°",
  "response": "è§’è‰²çš„å›ç­”",
  "round_number": 2
}
```

### 7. è·å–æç¤º
```http
POST /api/game/hint
```
**è¯´æ˜**: è·å–æ¸¸æˆæç¤º  

**è¯·æ±‚ä½“**:
```json
{
  "session_id": "uuid-string"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "hint": "æç¤ºå†…å®¹",
  "hints_used": 1,
  "max_hints": 3
}
```

### 8. è·å–è°ƒæŸ¥æ€»ç»“
```http
POST /api/game/investigation/summary
```
**è¯´æ˜**: è·å–å½“å‰è°ƒæŸ¥è¿›åº¦æ€»ç»“  

**è¯·æ±‚ä½“**:
```json
{
  "session_id": "uuid-string"
}
```

### 9. æäº¤æŒ‡æ§ï¼ˆæµå¼å®¡åˆ¤ï¼‰
```http
POST /api/game/accusation/stream
```
**è¯´æ˜**: æäº¤æŒ‡æ§å¹¶è·å–æµå¼å®¡åˆ¤è¿‡ç¨‹  

**è¯·æ±‚ä½“**:
```json
{
  "session_id": "uuid-string",
  "accused_name": "è¢«æŒ‡æ§è€…å§“å",
  "reasoning": "æŒ‡æ§ç†ç”±"
}
```

**å“åº”**: Server-Sent Events (SSE) æµå¼å®¡åˆ¤æ•°æ®

### 10. ç»“æŸæ¸¸æˆ
```http
DELETE /api/game/{session_id}
```
**è¯´æ˜**: ç»“æŸæŒ‡å®šçš„æ¸¸æˆä¼šè¯  

**è·¯å¾„å‚æ•°**:
- `session_id`: æ¸¸æˆä¼šè¯ID

---

## ğŸ“Š æ•°æ®æŸ¥è¯¢æ¥å£

### 1. æäº¤æ¸¸æˆè¯„ä»·
```http
POST /api/game/evaluation
```
**è¯´æ˜**: æäº¤æ¸¸æˆç»“æŸåçš„è¯„ä»·  

**è¯·æ±‚ä½“**:
```json
{
  "session_id": "uuid-string",
  "rating": 5,
  "reason": "è¯„ä»·ç†ç”±",
  "difficulty_feedback": "just_right",
  "most_liked": "æœ€å–œæ¬¢çš„éƒ¨åˆ†",
  "suggestions": "æ”¹è¿›å»ºè®®",
  "would_recommend": true
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "evaluation_id": 123,
  "session_id": "uuid-string",
  "rating": 5,
  "reason": "è¯„ä»·ç†ç”±",
  "created_at": "2025-06-15T11:30:00+08:00"
}
```

### 2. è·å–æ¸¸æˆå›æ”¾
```http
GET /api/game/{session_id}/replay
```
**è¯´æ˜**: è·å–æŒ‡å®šä¼šè¯çš„å®Œæ•´å›æ”¾æ•°æ®  

**è·¯å¾„å‚æ•°**:
- `session_id`: æ¸¸æˆä¼šè¯ID

**å“åº”ç¤ºä¾‹**:
```json
{
  "session_info": {
    "session_id": "uuid-string",
    "player_name": "ç©å®¶åç§°",
    "case_title": "æ¡ˆä¾‹æ ‡é¢˜",
    "start_time": "2025-06-15T10:00:00+08:00",
    "end_time": "2025-06-15T10:45:00+08:00",
    "is_completed": true,
    "is_solved": true
  },
  "conversations": [...],
  "evaluation": {...}
}
```

### 3. è·å–ä¼šè¯åˆ—è¡¨
```http
GET /api/game/sessions
```
**è¯´æ˜**: è·å–æ¸¸æˆä¼šè¯åˆ—è¡¨  

**æŸ¥è¯¢å‚æ•°**:
- `limit` (é»˜è®¤50): è¿”å›æ•°é‡é™åˆ¶
- `offset` (é»˜è®¤0): åç§»é‡

### 4. è·å–è¯„ä»·ç»Ÿè®¡
```http
GET /api/game/statistics
```
**è¯´æ˜**: è·å–æ¸¸æˆè¯„ä»·ç»Ÿè®¡æ•°æ®  

**å“åº”ç¤ºä¾‹**:
```json
{
  "total_evaluations": 100,
  "average_rating": 4.2,
  "rating_distribution": {
    "5_stars": 45,
    "4_stars": 30,
    "3_stars": 15,
    "2_stars": 8,
    "1_star": 2
  },
  "recommendation_rate": 85.5
}
```

---

## ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜æ¥å£

### 1. ç®¡ç†å‘˜ç™»å½•
```http
POST /api/admin/login
```
**è¯´æ˜**: ç®¡ç†å‘˜èº«ä»½éªŒè¯  

**è¯·æ±‚ä½“**:
```json
{
  "password": "ç®¡ç†å‘˜å¯†ç "
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "token": "jwt-token-string",
  "message": "ç™»å½•æˆåŠŸ"
}
```

### 2. ç®¡ç†å‘˜ç™»å‡º
```http
POST /api/admin/logout
```
**è¯´æ˜**: ç®¡ç†å‘˜ç™»å‡º  
**è®¤è¯**: éœ€è¦Bearer Token

### 3. è·å–ç®¡ç†ç»Ÿè®¡æ•°æ®
```http
GET /api/admin/statistics
```
**è¯´æ˜**: è·å–è¯¦ç»†çš„ç®¡ç†ç»Ÿè®¡æ•°æ®  
**è®¤è¯**: éœ€è¦Bearer Token

**æŸ¥è¯¢å‚æ•°**:
- `days` (é»˜è®¤30): ç»Ÿè®¡å¤©æ•°

**å“åº”ç¤ºä¾‹**:
```json
{
  "daily_stats": [...],
  "overall_stats": {
    "total_games": 500,
    "total_unique_users": 200,
    "overall_completion_rate": 75.5,
    "overall_success_rate": 45.2
  },
  "user_activity": {...}
}
```

### 4. è·å–ç®¡ç†ä¼šè¯åˆ—è¡¨
```http
GET /api/admin/sessions
```
**è¯´æ˜**: è·å–è¯¦ç»†çš„ä¼šè¯ç®¡ç†åˆ—è¡¨  
**è®¤è¯**: éœ€è¦Bearer Token

**æŸ¥è¯¢å‚æ•°**:
- `limit` (é»˜è®¤50): è¿”å›æ•°é‡é™åˆ¶
- `offset` (é»˜è®¤0): åç§»é‡
- `has_evaluation` (å¯é€‰): ç­›é€‰æ˜¯å¦æœ‰è¯„ä»·

### 5. ç®¡ç†é¡µé¢
```http
GET /admin
GET /admin/dashboard
GET /admin/history
```
**è¯´æ˜**: è¿”å›ç®¡ç†åå°é¡µé¢  
**å“åº”**: HTMLé¡µé¢

---

## âš™ï¸ ç³»ç»Ÿæ¥å£

### 1. å¥åº·æ£€æŸ¥
```http
GET /api/health
```
**è¯´æ˜**: ç³»ç»Ÿå¥åº·çŠ¶æ€æ£€æŸ¥  

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "healthy",
  "timestamp": "2025-06-15T11:30:00+08:00",
  "version": "1.7.0",
  "cases_count": 5
}
```

### 2. ç‰ˆæœ¬ä¿¡æ¯
```http
GET /api/version
```
**è¯´æ˜**: è·å–åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯  

**å“åº”ç¤ºä¾‹**:
```json
{
  "version": "1.7.0",
  "build_date": "2025-06-15",
  "environment": "production"
}
```

### 3. åº”ç”¨é…ç½®
```http
GET /api/config
```
**è¯´æ˜**: è·å–åº”ç”¨é…ç½®ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ—¶åŒºè®¾ç½®ï¼‰  

**å“åº”ç¤ºä¾‹**:
```json
{
  "timezone": "Asia/Shanghai",
  "timezone_offset": 8,
  "version": "1.7.0"
}
```

### 4. æ•°æ®åº“åˆå§‹åŒ–
```http
POST /api/database/init
```
**è¯´æ˜**: åˆå§‹åŒ–æ•°æ®åº“ï¼ˆè°ƒè¯•ç”¨ï¼‰  

### 5. æµå¼æµ‹è¯•
```http
POST /api/test/stream
```
**è¯´æ˜**: æµ‹è¯•æµå¼å“åº”åŠŸèƒ½ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰  

---

## ğŸ“‹ æ•°æ®æ¨¡å‹

### GameSessionResponse
```typescript
interface GameSessionResponse {
  session_id: string;
  case_title: string;
  current_round: number;
  max_rounds: number;
  hints_used: number;
  max_hints: number;
  characters: Character[];
  conversation_history: Record<string, Conversation[]>;
}
```

### Character
```typescript
interface Character {
  name: string;
  occupation: string;
  character_type: string;
  background: string;
  personality: string;
  relationship_to_victim: string;
}
```

### Conversation
```typescript
interface Conversation {
  id: number;
  round_number: number;
  timestamp: string;
  speaker_type: string;
  speaker_name: string;
  message_type: string;
  content: string;
  extra_data?: any;
}
```

---

## âŒ é”™è¯¯ç è¯´æ˜

| çŠ¶æ€ç  | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| 200 | è¯·æ±‚æˆåŠŸ | æ­£å¸¸å“åº” |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ | ç¼ºå°‘å¿…éœ€å‚æ•° |
| 401 | æœªæˆæƒ | ç®¡ç†å‘˜tokenæ— æ•ˆ |
| 404 | èµ„æºä¸å­˜åœ¨ | ä¼šè¯IDä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æ•°æ®åº“è¿æ¥å¤±è´¥ |

### é”™è¯¯å“åº”æ ¼å¼
```json
{
  "detail": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### JavaScript å‰ç«¯è°ƒç”¨ç¤ºä¾‹
```javascript
// å¼€å§‹æ¸¸æˆ
const startGame = async (caseIndex) => {
  const response = await fetch('/api/game/start', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ case_index: caseIndex })
  });
  return await response.json();
};

// è·å–åº”ç”¨é…ç½®
const getConfig = async () => {
  const response = await fetch('/api/config');
  const config = await response.json();
  console.log('å½“å‰æ—¶åŒº:', config.timezone);
};

// æµå¼æé—®
const askQuestionStream = async (sessionId, characterName, question) => {
  const response = await fetch('/api/game/question/stream', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      session_id: sessionId,
      character_name: characterName,
      question: question
    })
  });
  
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    const chunk = decoder.decode(value);
    console.log('æ”¶åˆ°å“åº”ç‰‡æ®µ:', chunk);
  }
};
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ—¶åŒºå¤„ç†**: æ‰€æœ‰æ—¶é—´ç›¸å…³çš„APIéƒ½ä¼šæ ¹æ® `TIMEZONE` ç¯å¢ƒå˜é‡è¿”å›å¯¹åº”æ—¶åŒºçš„æ—¶é—´
2. **æµå¼å“åº”**: éƒ¨åˆ†æ¥å£æ”¯æŒServer-Sent Eventsï¼Œéœ€è¦æ­£ç¡®å¤„ç†æµå¼æ•°æ®
3. **è®¤è¯æœºåˆ¶**: ç®¡ç†å‘˜æ¥å£éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŒ…å« `Authorization: Bearer <token>`
4. **é”™è¯¯å¤„ç†**: å»ºè®®å¯¹æ‰€æœ‰APIè°ƒç”¨è¿›è¡Œé€‚å½“çš„é”™è¯¯å¤„ç†
5. **ä¼šè¯ç®¡ç†**: æ¸¸æˆä¼šè¯æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œé•¿æ—¶é—´ä¸æ´»åŠ¨å¯èƒ½è¢«æ¸…ç†

---
*æ–‡æ¡£ç‰ˆæœ¬: v1.7.0*  
*æœ€åæ›´æ–°: 2025-06-15* 
