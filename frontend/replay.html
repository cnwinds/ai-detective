<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê∏∏ÊàèÂõûÊîæ - AI‰æ¶Êé¢Êé®ÁêÜÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }

        .info-value {
            color: #333;
            font-size: 14px;
            margin-top: 2px;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a626b;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .conversation-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-height: 60vh;
            overflow-y: auto;
        }

        .conversation-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ddd;
            opacity: 0.3;
            transition: all 0.5s ease;
        }

        .conversation-item.active {
            opacity: 1;
            transform: scale(1.02);
        }

        .conversation-item.played {
            opacity: 0.8;
        }

        .conversation-item.player {
            background: #e1f5fe;
            border-left-color: #2196f3;
        }

        .conversation-item.character {
            background: #f1e6ff;
            border-left-color: #9c27b0;
        }

        .conversation-item.system {
            background: #fff8e1;
            border-left-color: #ff9800;
        }

        .conversation-item.accusation {
            background: #ffebee;
            border-left-color: #f44336;
            font-weight: bold;
        }

        .conversation-item.defense {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .conversation-item.testimony {
            background: #e1f5fe;
            border-left-color: #2196f3;
        }

        .conversation-item.vote {
            background: #f1e6ff;
            border-left-color: #9c27b0;
        }

        .conversation-item.verdict {
            background: #fff3c4;
            border-left-color: #ffc107;
            font-weight: bold;
            font-size: 16px;
        }

        .conversation-item.solution {
            background: #e8f5e8;
            border-left-color: #4caf50;
            font-style: italic;
        }

        .speaker {
            font-weight: bold;
            color: #111;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .timestamp {
            font-size: 12px;
            color: #555;
            font-weight: normal;
        }

        .content {
            color: #222;
            line-height: 1.6;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
        }

        .support {
            color: #28a745;
            font-weight: bold;
        }

        .oppose {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé¨ Ê∏∏ÊàèÂõûÊîæ</h1>
        <div id="sessionInfo" class="session-info">
            <!-- ‰ºöËØù‰ø°ÊÅØÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" id="playBtn" onclick="togglePlay()">‚ñ∂Ô∏è Êí≠Êîæ</button>
        <button class="btn btn-secondary" onclick="resetReplay()">üîÑ ÈáçÁΩÆ</button>
        <button class="btn btn-secondary" onclick="goHome()">üè† ÂõûÂà∞È¶ñÈ°µ</button>
    </div>

    <div id="evaluationSection" class="header" style="display: none;">
        <h3>üåü Ê∏∏ÊàèËØÑ‰ª∑</h3>
        <div id="evaluationContent">
            <!-- ËØÑ‰ª∑ÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
        </div>
    </div>

    <div id="loadingDiv" class="loading">
        <p>Ê≠£Âú®Âä†ËΩΩÂõûÊîæÊï∞ÊçÆ...</p>
    </div>

    <div id="errorDiv" class="error" style="display: none;">
        <p id="errorMessage">Âä†ËΩΩÂ§±Ë¥•</p>
    </div>

    <div id="conversationContainer" class="conversation-container" style="display: none;">
        <!-- ÂØπËØùÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
    </div>

    <script>
        let replayData = null;
        let currentIndex = 0;
        let isPlaying = false;
        let appTimezone = 'Asia/Shanghai'; // ÈªòËÆ§Êó∂Âå∫

        // Ëé∑ÂèñURLÂèÇÊï∞
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        const sessionId = getUrlParameter('session_id');

        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÂõûÊîæÊï∞ÊçÆ
        document.addEventListener('DOMContentLoaded', async function() {
            if (!sessionId) {
                showError('Áº∫Â∞ë‰ºöËØùIDÔºåËØ∑‰ªé‰ºöËØùÂàóË°®‰∏≠ËøõÂÖ•Ê≠§È°µÈù¢');
                return;
            }
            
            // ÂÖàËé∑ÂèñÂ∫îÁî®ÈÖçÁΩÆÔºàÂåÖÊã¨Êó∂Âå∫Ôºâ
            try {
                const configResponse = await fetch('/api/config');
                if (configResponse.ok) {
                    const config = await configResponse.json();
                    appTimezone = config.timezone;
                }
            } catch (error) {
                console.warn('Ëé∑ÂèñÂ∫îÁî®ÈÖçÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Êó∂Âå∫:', error);
            }
            
            loadReplayData();
        });

        // Âä†ËΩΩÂõûÊîæÊï∞ÊçÆ
        async function loadReplayData() {
            try {
                const response = await fetch(`/api/game/${sessionId}/replay`);
                if (!response.ok) {
                    throw new Error('Âä†ËΩΩÂõûÊîæÊï∞ÊçÆÂ§±Ë¥•');
                }
                
                replayData = await response.json();
                displaySessionInfo();
                displayConversations();
                
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('conversationContainer').style.display = 'block';
                
            } catch (error) {
                console.error('Âä†ËΩΩÂõûÊîæÊï∞ÊçÆÂ§±Ë¥•:', error);
                showError('Âä†ËΩΩÂõûÊîæÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
            }
        }

        // ËÆ°ÁÆóÂØπËØùËΩÆÊï∞
        function calculateConversationRounds() {
            if (!replayData || !replayData.conversations) return 0;
            
            // ËÆ°ÁÆóÈóÆÁ≠îÂØπÁöÑÊï∞Èáè
            const questions = replayData.conversations.filter(conv => 
                conv.message_type === 'question' || 
                (conv.speaker_type === 'player' && !conv.message_type)
            );
            
            return questions.length;
        }

        // ÊòæÁ§∫‰ºöËØù‰ø°ÊÅØ
        function displaySessionInfo() {
            const info = replayData.session_info;
            const container = document.getElementById('sessionInfo');
            
            const startTime = new Date(info.start_time).toLocaleString('zh-CN', { timeZone: appTimezone });
            const endTime = info.end_time ? new Date(info.end_time).toLocaleString('zh-CN', { timeZone: appTimezone }) : 'Êú™ÂÆåÊàê';

            container.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Ê°à‰ª∂Ê†áÈ¢ò</div>
                    <div class="info-value">${info.case_title}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÂºÄÂßãÊó∂Èó¥</div>
                    <div class="info-value">${startTime}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÁªìÊùüÊó∂Èó¥</div>
                    <div class="info-value">${endTime}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÂØπËØùËΩÆÊï∞</div>
                    <div class="info-value">${calculateConversationRounds()} ËΩÆ</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ê∏∏ÊàèÁä∂ÊÄÅ</div>
                    <div class="info-value">${info.is_solved ? '‚úÖ Â∑≤Ëß£ÂÜ≥' : '‚ùå Êú™Ëß£ÂÜ≥'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">‰ΩøÁî®ÊèêÁ§∫</div>
                    <div class="info-value">${info.hints_used || 0} Ê¨°</div>
                </div>
                ${info.client_id ? `
                    <div class="info-item">
                        <div class="info-label">ÂÆ¢Êà∑Á´ØÊ†áËØÜ</div>
                        <div class="info-value" style="font-family: monospace; font-size: 0.9em;">${info.client_id}</div>
                    </div>
                ` : ''}
                ${info.ip_address ? `
                    <div class="info-item">
                        <div class="info-label">IPÂú∞ÂùÄ</div>
                        <div class="info-value">${info.ip_address}</div>
                    </div>
                ` : ''}
                ${info.game_version ? `
                    <div class="info-item">
                        <div class="info-label">Ê∏∏ÊàèÁâàÊú¨</div>
                        <div class="info-value">${info.game_version}</div>
                    </div>
                ` : ''}
            `;

            // ÊòæÁ§∫ËØÑ‰ª∑‰ø°ÊÅØ
            if (replayData.evaluation) {
                displayEvaluation();
            }
        }

        // ÊòæÁ§∫ËØÑ‰ª∑‰ø°ÊÅØ
        function displayEvaluation() {
            const evaluation = replayData.evaluation;
            const container = document.getElementById('evaluationContent');
            const section = document.getElementById('evaluationSection');
            
            const stars = '‚≠ê'.repeat(evaluation.rating) + '‚òÜ'.repeat(5 - evaluation.rating);
            const difficultyMap = {
                'too_easy': 'Â§™ÁÆÄÂçï',
                'just_right': 'ÂàöÂ•Ω',
                'too_hard': 'Â§™Âõ∞Èöæ'
            };
            
            container.innerHTML = `
                <div class="session-info">
                    <div class="info-item">
                        <div class="info-label">ËØÑÂàÜ</div>
                        <div class="info-value">${stars} (${evaluation.rating}/5)</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ËØÑ‰ª∑ÁêÜÁî±</div>
                        <div class="info-value">${evaluation.reason}</div>
                    </div>
                    ${evaluation.difficulty_feedback ? `
                        <div class="info-item">
                            <div class="info-label">ÈöæÂ∫¶ÂèçÈ¶à</div>
                            <div class="info-value">${difficultyMap[evaluation.difficulty_feedback] || evaluation.difficulty_feedback}</div>
                        </div>
                    ` : ''}
                    ${evaluation.most_liked ? `
                        <div class="info-item">
                            <div class="info-label">ÊúÄÂñúÊ¨¢ÁöÑÈÉ®ÂàÜ</div>
                            <div class="info-value">${evaluation.most_liked}</div>
                        </div>
                    ` : ''}
                    ${evaluation.suggestions ? `
                        <div class="info-item">
                            <div class="info-label">ÊîπËøõÂª∫ËÆÆ</div>
                            <div class="info-value">${evaluation.suggestions}</div>
                        </div>
                    ` : ''}
                    ${evaluation.would_recommend !== null ? `
                        <div class="info-item">
                            <div class="info-label">ÊòØÂê¶Êé®Ëçê</div>
                            <div class="info-value">${evaluation.would_recommend ? '‚úÖ ÊòØ' : '‚ùå Âê¶'}</div>
                        </div>
                    ` : ''}
                    <div class="info-item">
                        <div class="info-label">ËØÑ‰ª∑Êó∂Èó¥</div>
                        <div class="info-value">${new Date(evaluation.created_at).toLocaleString('zh-CN', { timeZone: appTimezone })}</div>
                    </div>
                </div>
            `;
            
            section.style.display = 'block';
        }

        // ÊòæÁ§∫ÂØπËØùÂÜÖÂÆπ
        function displayConversations() {
            const container = document.getElementById('conversationContainer');
            const conversations = replayData.conversations;
            
            container.innerHTML = conversations.map((conv, index) => {
                const speakerName = conv.speaker_name || getSpeakerDisplayName(conv.speaker_type, conv.message_type, conv.extra_data);
                const time = new Date(conv.timestamp).toLocaleString('zh-CN', { timeZone: appTimezone });
                const messageTypeClass = conv.message_type || conv.speaker_type;
                
                return `
                    <div class="conversation-item ${messageTypeClass}" data-index="${index}">
                        <div class="speaker">
                            <span>${getMessageTypeIcon(conv.message_type)} ${speakerName}</span>
                            <span class="timestamp">${time}</span>
                        </div>
                        <div class="content">${formatContent(conv.content, conv.message_type)}</div>
                    </div>
                `;
            }).join('');
        }

        // Ëé∑ÂèñÂèëË®ÄËÄÖÊòæÁ§∫ÂêçÁß∞
        function getSpeakerDisplayName(speakerType, messageType, extraData) {
            if (messageType) {
                const messageTypeNames = {
                    'question': 'üë§ Áé©ÂÆ∂ÊèêÈóÆ',
                    'answer': 'üé≠ ËßíËâ≤ÂõûÁ≠î',
                    'accusation': '‚öñÔ∏è Áé©ÂÆ∂ÊåáÊéß',
                    'defense': 'üõ°Ô∏è Ë¢´ÂëäËæ©Êä§',
                    'testimony': 'üë• ËØÅ‰∫∫ËØÅËØç',
                    'vote': 'üó≥Ô∏è Èô™ÂÆ°Âõ¢ÊäïÁ•®',
                    'verdict': '‚öñÔ∏è ÊúÄÁªàÂà§ÂÜ≥',
                    'solution': 'üîç Ê°à‰ª∂ÁúüÁõ∏'
                };
                
                // ÁâπÊÆäÂ§ÑÁêÜÁé©ÂÆ∂ÊèêÈóÆÔºåÊòæÁ§∫Ë¢´ÊèêÈóÆÁöÑËßíËâ≤
                if (messageType === 'question' && extraData && extraData.character_target) {
                    return `üë§ Áé©ÂÆ∂Âêë ${extraData.character_target} ÊèêÈóÆ`;
                }
                
                if (messageTypeNames[messageType]) {
                    return messageTypeNames[messageType];
                }
            }
            
            const names = {
                'player': 'üë§ Áé©ÂÆ∂',
                'character': 'üé≠ ËßíËâ≤',
                'narrator': 'üìñ ÂèôËø∞ËÄÖ',
                'system': 'üñ•Ô∏è Á≥ªÁªü'
            };
            return names[speakerType] || speakerType;
        }

        // Ëé∑ÂèñÊ∂àÊÅØÁ±ªÂûãÂõæÊ†á
        function getMessageTypeIcon(messageType) {
            const icons = {
                'question': '‚ùì',
                'answer': 'üí¨',
                'accusation': '‚öñÔ∏è',
                'defense': 'üõ°Ô∏è',
                'testimony': 'üë•',
                'vote': 'üó≥Ô∏è',
                'verdict': '‚öñÔ∏è',
                'solution': 'üîç'
            };
            return icons[messageType] || '';
        }

        // Ê†ºÂºèÂåñÂÜÖÂÆπ
        function formatContent(content, messageType) {
            // ÂØπ‰∫éÊäïÁ•®ÂÜÖÂÆπÔºåÁâπÊÆäÊ†ºÂºèÂåñ
            if (messageType === 'vote' && content.includes('ÊäïÁ•®Ôºö')) {
                // ÂÖàÂ∞ÜÊç¢Ë°åÁ¨¶ËΩ¨Êç¢‰∏∫HTMLÊç¢Ë°å
                let formattedContent = content.replace(/\n/g, '<br/>');
                
                // Êü•ÊâæÊäïÁ•®ÂíåÂéüÂõ†ÁöÑÂàÜÈöîÁ¨¶
                if (formattedContent.includes(' - ')) {
                    const parts = formattedContent.split(' - ');
                    const vote = parts[0];
                    const reason = parts.slice(1).join(' - ');
                    const voteClass = vote.includes('ÊîØÊåÅ') ? 'support' : 'oppose';
                    
                    // Ê†ºÂºèÂåñÔºöÊäïÁ•®ÁªìÊûúÂä†Á≤óÔºåÂéüÂõ†ÈÉ®ÂàÜÊç¢Ë°åÊòæÁ§∫
                    return `<strong class="${voteClass}">${vote}</strong><br/><strong>ÂéüÂõ†Ôºö</strong><br/>${reason}`;
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂàÜÈöîÁ¨¶ÔºåÂ∞ùËØïÊü•Êâæ"ÂéüÂõ†Ôºö"
                    if (formattedContent.includes('ÂéüÂõ†Ôºö')) {
                        const voteMatch = formattedContent.match(/^ÊäïÁ•®Ôºö(ÊîØÊåÅ|ÂèçÂØπ)/);
                        if (voteMatch) {
                            const voteResult = voteMatch[0];
                            const voteClass = voteResult.includes('ÊîØÊåÅ') ? 'support' : 'oppose';
                            const reasonPart = formattedContent.replace(/^ÊäïÁ•®Ôºö(ÊîØÊåÅ|ÂèçÂØπ)<br\/>?/, '');
                            
                            return `<strong class="${voteClass}">${voteResult}</strong><br/>${reasonPart}`;
                        }
                    }
                }
                
                // Â¶ÇÊûúÊ†ºÂºè‰∏çÂåπÈÖçÔºåÁõ¥Êé•ËøîÂõûÊ†ºÂºèÂåñÂêéÁöÑÂÜÖÂÆπ
                return formattedContent;
            }
            
            // ÂØπ‰∫éÂà§ÂÜ≥ÂÜÖÂÆπÔºåÂèØ‰ª•ÁâπÊÆäÊ†ºÂºèÂåñ
            if (messageType === 'verdict') {
                return `<strong>${content}</strong>`;
            }
            
            // Â∞ÜÊç¢Ë°åÁ¨¶ËΩ¨Êç¢‰∏∫HTMLÊç¢Ë°å
            return content.replace(/\n/g, '<br/>');
        }

        // Êí≠ÊîæÊéßÂà∂
        function togglePlay() {
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                isPlaying = false;
                playBtn.innerHTML = '‚ñ∂Ô∏è Êí≠Êîæ';
            } else {
                isPlaying = true;
                playBtn.innerHTML = '‚è∏Ô∏è ÊöÇÂÅú';
                playNext();
            }
        }

        // Êí≠Êîæ‰∏ã‰∏Ä‰∏™ÂØπËØù
        function playNext() {
            if (!isPlaying || !replayData || currentIndex >= replayData.conversations.length) {
                isPlaying = false;
                document.getElementById('playBtn').innerHTML = '‚ñ∂Ô∏è Êí≠Êîæ';
                return;
            }

            // È´ò‰∫ÆÂΩìÂâçÂØπËØù
            const items = document.querySelectorAll('.conversation-item');
            
            // Â∞Ü‰πãÂâçÁöÑËÆæ‰∏∫Â∑≤Êí≠Êîæ
            if (currentIndex > 0) {
                items[currentIndex - 1].classList.remove('active');
                items[currentIndex - 1].classList.add('played');
            }
            
            // È´ò‰∫ÆÂΩìÂâçÈ°π
            if (items[currentIndex]) {
                items[currentIndex].classList.add('active');
                items[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            currentIndex++;

            // ËÆæÁΩÆ‰∏ãÊ¨°Êí≠ÊîæÁöÑÂª∂Êó∂
            if (isPlaying) {
                setTimeout(playNext, 2000);
            }
        }

        // ÈáçÁΩÆÊí≠Êîæ
        function resetReplay() {
            isPlaying = false;
            currentIndex = 0;
            
            // ÈáçÁΩÆÊâÄÊúâÂØπËØùÈ°πÁöÑÁä∂ÊÄÅ
            const items = document.querySelectorAll('.conversation-item');
            items.forEach(item => {
                item.classList.remove('active', 'played');
            });
            
            // ÈáçÁΩÆÊí≠ÊîæÊåâÈíÆ
            document.getElementById('playBtn').innerHTML = '‚ñ∂Ô∏è Êí≠Êîæ';
        }

        // ÂØºËà™ÂäüËÉΩ
        function goHome() {
            window.location.href = '/';
        }

        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }
    </script>
</body>
</html> 