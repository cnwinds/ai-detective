<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆå›æ”¾ - AIä¾¦æ¢æ¨ç†æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }

        .info-value {
            color: #333;
            font-size: 14px;
            margin-top: 2px;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a626b;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .conversation-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-height: 60vh;
            overflow-y: auto;
        }

        .conversation-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ddd;
            opacity: 0.3;
            transition: all 0.5s ease;
        }

        .conversation-item.active {
            opacity: 1;
            transform: scale(1.02);
        }

        .conversation-item.played {
            opacity: 0.8;
        }

        .conversation-item.player {
            background: #e1f5fe;
            border-left-color: #2196f3;
        }

        .conversation-item.character {
            background: #f1e6ff;
            border-left-color: #9c27b0;
        }

        .conversation-item.system {
            background: #fff8e1;
            border-left-color: #ff9800;
        }

        .conversation-item.accusation {
            background: #ffebee;
            border-left-color: #f44336;
            font-weight: bold;
        }

        .conversation-item.defense {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .conversation-item.testimony {
            background: #e1f5fe;
            border-left-color: #2196f3;
        }

        .conversation-item.vote {
            background: #f1e6ff;
            border-left-color: #9c27b0;
        }

        .conversation-item.verdict {
            background: #fff3c4;
            border-left-color: #ffc107;
            font-weight: bold;
            font-size: 16px;
        }

        .conversation-item.solution {
            background: #e8f5e8;
            border-left-color: #4caf50;
            font-style: italic;
        }

        .speaker {
            font-weight: bold;
            color: #111;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .timestamp {
            font-size: 12px;
            color: #555;
            font-weight: normal;
        }

        .content {
            color: #222;
            line-height: 1.6;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
        }

        .support {
            color: #28a745;
            font-weight: bold;
        }

        .oppose {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¬ æ¸¸æˆå›æ”¾</h1>
        <div id="sessionInfo" class="session-info">
            <!-- ä¼šè¯ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" id="playBtn" onclick="togglePlay()">â–¶ï¸ æ’­æ”¾</button>
        <button class="btn btn-secondary" onclick="resetReplay()">ğŸ”„ é‡ç½®</button>
        <button class="btn btn-secondary" onclick="goHome()">ğŸ  å›åˆ°é¦–é¡µ</button>
    </div>

    <div id="evaluationSection" class="header" style="display: none;">
        <h3>ğŸŒŸ æ¸¸æˆè¯„ä»·</h3>
        <div id="evaluationContent">
            <!-- è¯„ä»·å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <div id="loadingDiv" class="loading">
        <p>æ­£åœ¨åŠ è½½å›æ”¾æ•°æ®...</p>
    </div>

    <div id="errorDiv" class="error" style="display: none;">
        <p id="errorMessage">åŠ è½½å¤±è´¥</p>
    </div>

    <div id="conversationContainer" class="conversation-container" style="display: none;">
        <!-- å¯¹è¯å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
    </div>

    <script>
        let replayData = null;
        let currentIndex = 0;
        let isPlaying = false;
        let appTimezone = 'Asia/Shanghai'; // é»˜è®¤æ—¶åŒº

        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        const sessionId = getUrlParameter('session_id');

        // é¡µé¢åŠ è½½æ—¶è·å–å›æ”¾æ•°æ®
        document.addEventListener('DOMContentLoaded', async function() {
            if (!sessionId) {
                showError('ç¼ºå°‘ä¼šè¯IDï¼Œè¯·ä»ä¼šè¯åˆ—è¡¨ä¸­è¿›å…¥æ­¤é¡µé¢');
                return;
            }
            
            // å…ˆè·å–åº”ç”¨é…ç½®ï¼ˆåŒ…æ‹¬æ—¶åŒºï¼‰
            try {
                const configResponse = await fetch('/api/config');
                if (configResponse.ok) {
                    const config = await configResponse.json();
                    appTimezone = config.timezone;
                }
            } catch (error) {
                console.warn('è·å–åº”ç”¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ—¶åŒº:', error);
            }
            
            loadReplayData();
        });

        // åŠ è½½å›æ”¾æ•°æ®
        async function loadReplayData() {
            try {
                const response = await fetch(`/api/game/${sessionId}/replay`);
                if (!response.ok) {
                    throw new Error('åŠ è½½å›æ”¾æ•°æ®å¤±è´¥');
                }
                
                replayData = await response.json();
                displaySessionInfo();
                displayConversations();
                
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('conversationContainer').style.display = 'block';
                
            } catch (error) {
                console.error('åŠ è½½å›æ”¾æ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½å›æ”¾æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // è®¡ç®—å¯¹è¯è½®æ•°
        function calculateConversationRounds() {
            if (!replayData || !replayData.conversations) return 0;
            
            // è®¡ç®—é—®ç­”å¯¹çš„æ•°é‡
            const questions = replayData.conversations.filter(conv => 
                conv.message_type === 'question' || 
                (conv.speaker_type === 'player' && !conv.message_type)
            );
            
            return questions.length;
        }

        // æ˜¾ç¤ºä¼šè¯ä¿¡æ¯
        function displaySessionInfo() {
            const info = replayData.session_info;
            const container = document.getElementById('sessionInfo');
            
            const startTime = new Date(info.start_time).toLocaleString('zh-CN', { timeZone: appTimezone });
            const endTime = info.end_time ? new Date(info.end_time).toLocaleString('zh-CN', { timeZone: appTimezone }) : 'æœªå®Œæˆ';

            container.innerHTML = `
                <div class="info-item">
                    <div class="info-label">æ¡ˆä»¶æ ‡é¢˜</div>
                    <div class="info-value">${info.case_title}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å¼€å§‹æ—¶é—´</div>
                    <div class="info-value">${startTime}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ç»“æŸæ—¶é—´</div>
                    <div class="info-value">${endTime}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å¯¹è¯è½®æ•°</div>
                    <div class="info-value">${calculateConversationRounds()} è½®</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ¸¸æˆçŠ¶æ€</div>
                    <div class="info-value">${info.is_solved ? 'âœ… å·²è§£å†³' : 'âŒ æœªè§£å†³'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ä½¿ç”¨æç¤º</div>
                    <div class="info-value">${info.hints_used || 0} æ¬¡</div>
                </div>
                ${info.client_id ? `
                    <div class="info-item">
                        <div class="info-label">å®¢æˆ·ç«¯æ ‡è¯†</div>
                        <div class="info-value" style="font-family: monospace; font-size: 0.9em;">${info.client_id}</div>
                    </div>
                ` : ''}
                ${info.ip_address ? `
                    <div class="info-item">
                        <div class="info-label">IPåœ°å€</div>
                        <div class="info-value">${info.ip_address}</div>
                    </div>
                ` : ''}
                ${info.game_version ? `
                    <div class="info-item">
                        <div class="info-label">æ¸¸æˆç‰ˆæœ¬</div>
                        <div class="info-value">${info.game_version}</div>
                    </div>
                ` : ''}
            `;

            // æ˜¾ç¤ºè¯„ä»·ä¿¡æ¯
            if (replayData.evaluation) {
                displayEvaluation();
            }
        }

        // æ˜¾ç¤ºè¯„ä»·ä¿¡æ¯
        function displayEvaluation() {
            const evaluation = replayData.evaluation;
            const container = document.getElementById('evaluationContent');
            const section = document.getElementById('evaluationSection');
            
            const stars = 'â­'.repeat(evaluation.rating) + 'â˜†'.repeat(5 - evaluation.rating);
            const difficultyMap = {
                'too_easy': 'å¤ªç®€å•',
                'just_right': 'åˆšå¥½',
                'too_hard': 'å¤ªå›°éš¾'
            };
            
            container.innerHTML = `
                <div class="session-info">
                    <div class="info-item">
                        <div class="info-label">è¯„åˆ†</div>
                        <div class="info-value">${stars} (${evaluation.rating}/5)</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è¯„ä»·ç†ç”±</div>
                        <div class="info-value">${evaluation.reason}</div>
                    </div>
                    ${evaluation.difficulty_feedback ? `
                        <div class="info-item">
                            <div class="info-label">éš¾åº¦åé¦ˆ</div>
                            <div class="info-value">${difficultyMap[evaluation.difficulty_feedback] || evaluation.difficulty_feedback}</div>
                        </div>
                    ` : ''}
                    ${evaluation.most_liked ? `
                        <div class="info-item">
                            <div class="info-label">æœ€å–œæ¬¢çš„éƒ¨åˆ†</div>
                            <div class="info-value">${evaluation.most_liked}</div>
                        </div>
                    ` : ''}
                    ${evaluation.suggestions ? `
                        <div class="info-item">
                            <div class="info-label">æ”¹è¿›å»ºè®®</div>
                            <div class="info-value">${evaluation.suggestions}</div>
                        </div>
                    ` : ''}
                    ${evaluation.would_recommend !== null ? `
                        <div class="info-item">
                            <div class="info-label">æ˜¯å¦æ¨è</div>
                            <div class="info-value">${evaluation.would_recommend ? 'âœ… æ˜¯' : 'âŒ å¦'}</div>
                        </div>
                    ` : ''}
                    <div class="info-item">
                        <div class="info-label">è¯„ä»·æ—¶é—´</div>
                        <div class="info-value">${new Date(evaluation.created_at).toLocaleString('zh-CN', { timeZone: appTimezone })}</div>
                    </div>
                </div>
            `;
            
            section.style.display = 'block';
        }

        // æ˜¾ç¤ºå¯¹è¯å†…å®¹
        function displayConversations() {
            const container = document.getElementById('conversationContainer');
            const conversations = replayData.conversations;
            
            container.innerHTML = conversations.map((conv, index) => {
                const speakerName = conv.speaker_name || getSpeakerDisplayName(conv.speaker_type, conv.message_type, conv.extra_data);
                const time = new Date(conv.timestamp).toLocaleString('zh-CN', { timeZone: appTimezone });
                const messageTypeClass = conv.message_type || conv.speaker_type;
                
                return `
                    <div class="conversation-item ${messageTypeClass}" data-index="${index}">
                        <div class="speaker">
                            <span>${getMessageTypeIcon(conv.message_type)} ${speakerName}</span>
                            <span class="timestamp">${time}</span>
                        </div>
                        <div class="content">${formatContent(conv.content, conv.message_type)}</div>
                    </div>
                `;
            }).join('');
        }

        // è·å–å‘è¨€è€…æ˜¾ç¤ºåç§°
        function getSpeakerDisplayName(speakerType, messageType, extraData) {
            if (messageType) {
                const messageTypeNames = {
                    'question': 'ğŸ‘¤ ç©å®¶æé—®',
                    'answer': 'ğŸ­ è§’è‰²å›ç­”',
                    'accusation': 'âš–ï¸ ç©å®¶æŒ‡æ§',
                    'defense': 'ğŸ›¡ï¸ è¢«å‘Šè¾©æŠ¤',
                    'testimony': 'ğŸ‘¥ è¯äººè¯è¯',
                    'vote': 'ğŸ—³ï¸ é™ªå®¡å›¢æŠ•ç¥¨',
                    'verdict': 'âš–ï¸ æœ€ç»ˆåˆ¤å†³',
                    'solution': 'ğŸ” æ¡ˆä»¶çœŸç›¸'
                };
                
                // ç‰¹æ®Šå¤„ç†ç©å®¶æé—®ï¼Œæ˜¾ç¤ºè¢«æé—®çš„è§’è‰²
                if (messageType === 'question' && extraData && extraData.character_target) {
                    return `ğŸ‘¤ ç©å®¶å‘ ${extraData.character_target} æé—®`;
                }
                
                if (messageTypeNames[messageType]) {
                    return messageTypeNames[messageType];
                }
            }
            
            const names = {
                'player': 'ğŸ‘¤ ç©å®¶',
                'character': 'ğŸ­ è§’è‰²',
                'narrator': 'ğŸ“– å™è¿°è€…',
                'system': 'ğŸ–¥ï¸ ç³»ç»Ÿ'
            };
            return names[speakerType] || speakerType;
        }

        // è·å–æ¶ˆæ¯ç±»å‹å›¾æ ‡
        function getMessageTypeIcon(messageType) {
            const icons = {
                'question': 'â“',
                'answer': 'ğŸ’¬',
                'accusation': 'âš–ï¸',
                'defense': 'ğŸ›¡ï¸',
                'testimony': 'ğŸ‘¥',
                'vote': 'ğŸ—³ï¸',
                'verdict': 'âš–ï¸',
                'solution': 'ğŸ”'
            };
            return icons[messageType] || '';
        }

        // æ ¼å¼åŒ–å†…å®¹
        function formatContent(content, messageType) {
            // å¯¹äºæŠ•ç¥¨å†…å®¹ï¼Œç‰¹æ®Šæ ¼å¼åŒ–
            if (messageType === 'vote' && content.includes('æŠ•ç¥¨ï¼š')) {
                // å…ˆå°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œ
                let formattedContent = content.replace(/\n/g, '<br/>');
                
                // æŸ¥æ‰¾æŠ•ç¥¨å’ŒåŸå› çš„åˆ†éš”ç¬¦
                if (formattedContent.includes(' - ')) {
                    const parts = formattedContent.split(' - ');
                    const vote = parts[0];
                    const reason = parts.slice(1).join(' - ');
                    const voteClass = vote.includes('æ”¯æŒ') ? 'support' : 'oppose';
                    
                    // æ ¼å¼åŒ–ï¼šæŠ•ç¥¨ç»“æœåŠ ç²—ï¼ŒåŸå› éƒ¨åˆ†æ¢è¡Œæ˜¾ç¤º
                    return `<strong class="${voteClass}">${vote}</strong><br/><strong>åŸå› ï¼š</strong><br/>${reason}`;
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ†éš”ç¬¦ï¼Œå°è¯•æŸ¥æ‰¾"åŸå› ï¼š"
                    if (formattedContent.includes('åŸå› ï¼š')) {
                        const voteMatch = formattedContent.match(/^æŠ•ç¥¨ï¼š(æ”¯æŒ|åå¯¹)/);
                        if (voteMatch) {
                            const voteResult = voteMatch[0];
                            const voteClass = voteResult.includes('æ”¯æŒ') ? 'support' : 'oppose';
                            const reasonPart = formattedContent.replace(/^æŠ•ç¥¨ï¼š(æ”¯æŒ|åå¯¹)<br\/>?/, '');
                            
                            return `<strong class="${voteClass}">${voteResult}</strong><br/>${reasonPart}`;
                        }
                    }
                }
                
                // å¦‚æœæ ¼å¼ä¸åŒ¹é…ï¼Œç›´æ¥è¿”å›æ ¼å¼åŒ–åçš„å†…å®¹
                return formattedContent;
            }
            
            // å¯¹äºåˆ¤å†³å†…å®¹ï¼Œå¯ä»¥ç‰¹æ®Šæ ¼å¼åŒ–
            if (messageType === 'verdict') {
                return `<strong>${content}</strong>`;
            }
            
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œ
            return content.replace(/\n/g, '<br/>');
        }

        // æ’­æ”¾æ§åˆ¶
        function togglePlay() {
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                isPlaying = false;
                playBtn.innerHTML = 'â–¶ï¸ æ’­æ”¾';
            } else {
                isPlaying = true;
                playBtn.innerHTML = 'â¸ï¸ æš‚åœ';
                playNext();
            }
        }

        // æ’­æ”¾ä¸‹ä¸€ä¸ªå¯¹è¯
        function playNext() {
            if (!isPlaying || !replayData || currentIndex >= replayData.conversations.length) {
                isPlaying = false;
                document.getElementById('playBtn').innerHTML = 'â–¶ï¸ æ’­æ”¾';
                return;
            }

            // é«˜äº®å½“å‰å¯¹è¯
            const items = document.querySelectorAll('.conversation-item');
            
            // å°†ä¹‹å‰çš„è®¾ä¸ºå·²æ’­æ”¾
            if (currentIndex > 0) {
                items[currentIndex - 1].classList.remove('active');
                items[currentIndex - 1].classList.add('played');
            }
            
            // é«˜äº®å½“å‰é¡¹
            if (items[currentIndex]) {
                items[currentIndex].classList.add('active');
                items[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            currentIndex++;

            // è®¾ç½®ä¸‹æ¬¡æ’­æ”¾çš„å»¶æ—¶
            if (isPlaying) {
                setTimeout(playNext, 2000);
            }
        }

        // é‡ç½®æ’­æ”¾
        function resetReplay() {
            isPlaying = false;
            currentIndex = 0;
            
            // é‡ç½®æ‰€æœ‰å¯¹è¯é¡¹çš„çŠ¶æ€
            const items = document.querySelectorAll('.conversation-item');
            items.forEach(item => {
                item.classList.remove('active', 'played');
            });
            
            // é‡ç½®æ’­æ”¾æŒ‰é’®
            document.getElementById('playBtn').innerHTML = 'â–¶ï¸ æ’­æ”¾';
        }

        // å¯¼èˆªåŠŸèƒ½
        function goHome() {
            window.location.href = '/';
        }

        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }
    </script>
</body>
</html> 