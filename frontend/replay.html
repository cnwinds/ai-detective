<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê∏∏ÊàèÂõûÊîæ - AI‰æ¶Êé¢Êé®ÁêÜÊ∏∏Êàè</title>
    <script src="/static/js/theme-manager.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: var(--theme-primary-bg);
            min-height: 100vh;
            padding: 20px;
            color: var(--theme-text-primary);
            transition: all 0.3s ease;
        }

        .header {
            background: var(--theme-secondary-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px var(--theme-shadow-color);
            border: 1px solid var(--theme-border-color);
        }

        .header h1 {
            color: var(--theme-text-primary);
            margin-bottom: 10px;
            text-shadow: 0 2px 4px var(--theme-shadow-color);
        }

        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: var(--theme-hover-bg);
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--theme-primary-color);
        }

        .info-label {
            font-weight: bold;
            color: var(--theme-text-secondary);
            font-size: 12px;
            text-transform: uppercase;
        }

        .info-value {
            color: var(--theme-text-primary);
            font-size: 14px;
            margin-top: 2px;
        }







        .conversation-container {
            background: var(--theme-secondary-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--theme-shadow-color);
            border: 1px solid var(--theme-border-color);
            max-height: 60vh;
            overflow-y: auto;
        }

        .conversation-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--theme-border-color);
            opacity: 1;
            transition: all 0.3s ease;
        }

        .conversation-item.player {
            background: var(--theme-info-bg);
            border-left-color: var(--theme-info-color);
        }

        .conversation-item.character {
            background: var(--theme-character-suspect-bg);
            border-left-color: var(--theme-character-suspect-color);
        }

        .conversation-item.system {
            background: var(--theme-badge-accent-bg);
            border-left-color: var(--theme-accent-color);
        }

        .conversation-item.accusation {
            background: var(--theme-warning-bg);
            border-left-color: var(--theme-warning-color);
            font-weight: bold;
        }

        .conversation-item.defense {
            background: var(--theme-success-bg);
            border-left-color: var(--theme-success-color);
        }

        .conversation-item.testimony {
            background: var(--theme-info-bg);
            border-left-color: var(--theme-info-color);
        }

        .conversation-item.vote {
            background: var(--theme-character-witness-bg);
            border-left-color: var(--theme-character-witness-color);
        }

        .conversation-item.verdict {
            background: var(--theme-badge-accent-bg);
            border-left-color: var(--theme-accent-color);
            font-weight: bold;
            font-size: 16px;
        }

        .conversation-item.solution {
            background: var(--theme-success-bg);
            border-left-color: var(--theme-success-color);
            font-style: italic;
        }

        .speaker {
            font-weight: bold;
            color: var(--theme-text-primary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .timestamp {
            font-size: 12px;
            color: var(--theme-text-secondary);
            font-weight: normal;
        }

        .content {
            color: var(--theme-text-primary);
            line-height: 1.6;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--theme-text-secondary);
        }

        .error {
            background: var(--theme-warning-bg);
            color: var(--theme-warning-color);
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
            border: 1px solid var(--theme-warning-color);
        }

        .support {
            color: var(--theme-success-color);
            font-weight: bold;
        }

        .oppose {
            color: var(--theme-warning-color);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé¨ Ê∏∏ÊàèÂõûÊîæ</h1>
        <div id="sessionInfo" class="session-info">
            <!-- ‰ºöËØù‰ø°ÊÅØÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
    </div>



    <div id="evaluationSection" class="header" style="display: none;">
        <h3>üåü Ê∏∏ÊàèËØÑ‰ª∑</h3>
        <div id="evaluationContent">
            <!-- ËØÑ‰ª∑ÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
        </div>
    </div>

    <div id="loadingDiv" class="loading">
        <p>Ê≠£Âú®Âä†ËΩΩÂõûÊîæÊï∞ÊçÆ...</p>
    </div>

    <div id="errorDiv" class="error" style="display: none;">
        <p id="errorMessage">Âä†ËΩΩÂ§±Ë¥•</p>
    </div>

    <div id="conversationContainer" class="conversation-container" style="display: none;">
        <!-- ÂØπËØùÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
    </div>

    <script>
        let replayData = null;
        let appTimezone = 'Asia/Shanghai'; // ÈªòËÆ§Êó∂Âå∫

        // Ëé∑ÂèñURLÂèÇÊï∞
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        const sessionId = getUrlParameter('session_id');

        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÂõûÊîæÊï∞ÊçÆ
        document.addEventListener('DOMContentLoaded', async function() {
            if (!sessionId) {
                showError('Áº∫Â∞ë‰ºöËØùIDÔºåËØ∑‰ªé‰ºöËØùÂàóË°®‰∏≠ËøõÂÖ•Ê≠§È°µÈù¢');
                return;
            }
            
            // ÂÖàËé∑ÂèñÂ∫îÁî®ÈÖçÁΩÆÔºàÂåÖÊã¨Êó∂Âå∫Ôºâ
            try {
                const configResponse = await fetch('/api/config');
                if (configResponse.ok) {
                    const config = await configResponse.json();
                    appTimezone = config.timezone;
                }
            } catch (error) {
                console.warn('Ëé∑ÂèñÂ∫îÁî®ÈÖçÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Êó∂Âå∫:', error);
            }
            
            loadReplayData();
        });

        // Âä†ËΩΩÂõûÊîæÊï∞ÊçÆ
        async function loadReplayData() {
            try {
                const response = await fetch(`/api/game/${sessionId}/replay`);
                if (!response.ok) {
                    throw new Error('Âä†ËΩΩÂõûÊîæÊï∞ÊçÆÂ§±Ë¥•');
                }
                
                replayData = await response.json();
                displaySessionInfo();
                displayConversations();
                
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('conversationContainer').style.display = 'block';
                
            } catch (error) {
                console.error('Âä†ËΩΩÂõûÊîæÊï∞ÊçÆÂ§±Ë¥•:', error);
                showError('Âä†ËΩΩÂõûÊîæÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
            }
        }

        // ËÆ°ÁÆóÂØπËØùËΩÆÊï∞
        function calculateConversationRounds() {
            if (!replayData || !replayData.conversations) return 0;
            
            // ËÆ°ÁÆóÈóÆÁ≠îÂØπÁöÑÊï∞Èáè
            const questions = replayData.conversations.filter(conv => 
                conv.message_type === 'question' || 
                (conv.speaker_type === 'player' && !conv.message_type)
            );
            
            return questions.length;
        }

        // ÊòæÁ§∫‰ºöËØù‰ø°ÊÅØ
        function displaySessionInfo() {
            const info = replayData.session_info;
            const container = document.getElementById('sessionInfo');
            
            const startTime = new Date(info.start_time).toLocaleString('zh-CN', { timeZone: appTimezone });
            
            // ËÆ°ÁÆóÊ∏∏ÊàèÊó∂Èïø
            let durationText = 'Êú™Áü•';
            if (info.start_time && info.end_time) {
                const startTimeObj = new Date(info.start_time);
                const endTimeObj = new Date(info.end_time);
                const durationMs = endTimeObj - startTimeObj;
                const minutes = Math.floor(durationMs / (1000 * 60));
                const seconds = Math.floor((durationMs % (1000 * 60)) / 1000);
                
                if (minutes > 0) {
                    durationText = `${minutes}ÂàÜ${seconds}Áßí`;
                } else {
                    durationText = `${seconds}Áßí`;
                }
            } else if (info.start_time && !info.end_time) {
                durationText = 'ËøõË°å‰∏≠';
            }

            container.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Ê°à‰ª∂Ê†áÈ¢ò</div>
                    <div class="info-value">${info.case_title}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÂºÄÂßãÊó∂Èó¥</div>
                    <div class="info-value">${startTime}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ê∏∏ÊàèÊó∂Èïø</div>
                    <div class="info-value">${durationText}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÂØπËØùËΩÆÊï∞</div>
                    <div class="info-value">${calculateConversationRounds()} ËΩÆ</div>
                </div>
                <div class="info-item">
                    <div class="info-label">‰ΩøÁî®ÊèêÁ§∫</div>
                    <div class="info-value">${info.hints_used || 0} Ê¨°</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ê∏∏ÊàèÁä∂ÊÄÅ</div>
                    <div class="info-value">${info.is_solved ? '‚úÖ Â∑≤Ëß£ÂÜ≥' : '‚ùå Êú™Ëß£ÂÜ≥'}</div>
                </div>
                ${info.client_id ? `
                    <div class="info-item">
                        <div class="info-label">ÂÆ¢Êà∑Á´ØÊ†áËØÜ</div>
                        <div class="info-value" style="font-family: monospace; font-size: 0.9em;">${info.client_id}</div>
                    </div>
                ` : ''}
                ${info.ip_address ? `
                    <div class="info-item">
                        <div class="info-label">IPÂú∞ÂùÄ</div>
                        <div class="info-value">${info.ip_address}</div>
                    </div>
                ` : ''}
                ${info.game_version ? `
                    <div class="info-item">
                        <div class="info-label">Ê∏∏ÊàèÁâàÊú¨</div>
                        <div class="info-value">${info.game_version}</div>
                    </div>
                ` : ''}
            `;

            // ÊòæÁ§∫ËØÑ‰ª∑‰ø°ÊÅØ
            if (replayData.evaluation) {
                displayEvaluation();
            }
        }

        // ÊòæÁ§∫ËØÑ‰ª∑‰ø°ÊÅØ
        function displayEvaluation() {
            const evaluation = replayData.evaluation;
            const container = document.getElementById('evaluationContent');
            const section = document.getElementById('evaluationSection');
            
            const stars = '‚≠ê'.repeat(evaluation.rating) + '‚òÜ'.repeat(5 - evaluation.rating);
            const difficultyMap = {
                'too_easy': 'Â§™ÁÆÄÂçï',
                'just_right': 'ÂàöÂ•Ω',
                'too_hard': 'Â§™Âõ∞Èöæ'
            };
            
            container.innerHTML = `
                <div class="session-info">
                    <div class="info-item">
                        <div class="info-label">ËØÑÂàÜ</div>
                        <div class="info-value">${stars} (${evaluation.rating}/5)</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ËØÑ‰ª∑ÁêÜÁî±</div>
                        <div class="info-value">${evaluation.reason}</div>
                    </div>
                    ${evaluation.difficulty_feedback ? `
                        <div class="info-item">
                            <div class="info-label">ÈöæÂ∫¶ÂèçÈ¶à</div>
                            <div class="info-value">${difficultyMap[evaluation.difficulty_feedback] || evaluation.difficulty_feedback}</div>
                        </div>
                    ` : ''}
                    ${evaluation.most_liked ? `
                        <div class="info-item">
                            <div class="info-label">ÊúÄÂñúÊ¨¢ÁöÑÈÉ®ÂàÜ</div>
                            <div class="info-value">${evaluation.most_liked}</div>
                        </div>
                    ` : ''}
                    ${evaluation.suggestions ? `
                        <div class="info-item">
                            <div class="info-label">ÊîπËøõÂª∫ËÆÆ</div>
                            <div class="info-value">${evaluation.suggestions}</div>
                        </div>
                    ` : ''}
                    ${evaluation.would_recommend !== null ? `
                        <div class="info-item">
                            <div class="info-label">ÊòØÂê¶Êé®Ëçê</div>
                            <div class="info-value">${evaluation.would_recommend ? '‚úÖ ÊòØ' : '‚ùå Âê¶'}</div>
                        </div>
                    ` : ''}
                    <div class="info-item">
                        <div class="info-label">ËØÑ‰ª∑Êó∂Èó¥</div>
                        <div class="info-value">${new Date(evaluation.created_at).toLocaleString('zh-CN', { timeZone: appTimezone })}</div>
                    </div>
                </div>
            `;
            
            section.style.display = 'block';
        }

        // ÊòæÁ§∫ÂØπËØùÂÜÖÂÆπ
        function displayConversations() {
            const container = document.getElementById('conversationContainer');
            const conversations = replayData.conversations;
            
            container.innerHTML = conversations.map((conv, index) => {
                const speakerName = conv.speaker_name || getSpeakerDisplayName(conv.speaker_type, conv.message_type, conv.extra_data);
                const time = new Date(conv.timestamp).toLocaleString('zh-CN', { timeZone: appTimezone });
                const messageTypeClass = conv.message_type || conv.speaker_type;
                
                return `
                    <div class="conversation-item ${messageTypeClass}" data-index="${index}">
                        <div class="speaker">
                            <span>${getMessageTypeIcon(conv.message_type)} ${speakerName}</span>
                            <span class="timestamp">${time}</span>
                        </div>
                        <div class="content">${formatContent(conv.content, conv.message_type)}</div>
                    </div>
                `;
            }).join('');
        }

        // Ëé∑ÂèñÂèëË®ÄËÄÖÊòæÁ§∫ÂêçÁß∞
        function getSpeakerDisplayName(speakerType, messageType, extraData) {
            if (messageType) {
                const messageTypeNames = {
                    'question': 'üë§ Áé©ÂÆ∂ÊèêÈóÆ',
                    'answer': 'üé≠ ËßíËâ≤ÂõûÁ≠î',
                    'accusation': '‚öñÔ∏è Áé©ÂÆ∂ÊåáÊéß',
                    'defense': 'üõ°Ô∏è Ë¢´ÂëäËæ©Êä§',
                    'testimony': 'üë• ËØÅ‰∫∫ËØÅËØç',
                    'vote': 'üó≥Ô∏è Èô™ÂÆ°Âõ¢ÊäïÁ•®',
                    'verdict': '‚öñÔ∏è ÊúÄÁªàÂà§ÂÜ≥',
                    'solution': 'üîç Ê°à‰ª∂ÁúüÁõ∏'
                };
                
                // ÁâπÊÆäÂ§ÑÁêÜÁé©ÂÆ∂ÊèêÈóÆÔºåÊòæÁ§∫Ë¢´ÊèêÈóÆÁöÑËßíËâ≤
                if (messageType === 'question' && extraData && extraData.character_target) {
                    return `üë§ Áé©ÂÆ∂Âêë ${extraData.character_target} ÊèêÈóÆ`;
                }
                
                if (messageTypeNames[messageType]) {
                    return messageTypeNames[messageType];
                }
            }
            
            const names = {
                'player': 'üë§ Áé©ÂÆ∂',
                'character': 'üé≠ ËßíËâ≤',
                'narrator': 'üìñ ÂèôËø∞ËÄÖ',
                'system': 'üñ•Ô∏è Á≥ªÁªü'
            };
            return names[speakerType] || speakerType;
        }

        // Ëé∑ÂèñÊ∂àÊÅØÁ±ªÂûãÂõæÊ†á
        function getMessageTypeIcon(messageType) {
            const icons = {
                'question': '‚ùì',
                'answer': 'üí¨',
                'accusation': '‚öñÔ∏è',
                'defense': 'üõ°Ô∏è',
                'testimony': 'üë•',
                'vote': 'üó≥Ô∏è',
                'verdict': '‚öñÔ∏è',
                'solution': 'üîç'
            };
            return icons[messageType] || '';
        }

        // Ê†ºÂºèÂåñÂÜÖÂÆπ
        function formatContent(content, messageType) {
            // ÂØπ‰∫éÊäïÁ•®ÂÜÖÂÆπÔºåÁâπÊÆäÊ†ºÂºèÂåñ
            if (messageType === 'vote' && content.includes('ÊäïÁ•®Ôºö')) {
                // ÂÖàÂ∞ÜÊç¢Ë°åÁ¨¶ËΩ¨Êç¢‰∏∫HTMLÊç¢Ë°å
                let formattedContent = content.replace(/\n/g, '<br/>');
                
                // Êü•ÊâæÊäïÁ•®ÂíåÂéüÂõ†ÁöÑÂàÜÈöîÁ¨¶
                if (formattedContent.includes(' - ')) {
                    const parts = formattedContent.split(' - ');
                    const vote = parts[0];
                    const reason = parts.slice(1).join(' - ');
                    const voteClass = vote.includes('ÊîØÊåÅ') ? 'support' : 'oppose';
                    
                    // Ê†ºÂºèÂåñÔºöÊäïÁ•®ÁªìÊûúÂä†Á≤óÔºåÂéüÂõ†ÈÉ®ÂàÜÊç¢Ë°åÊòæÁ§∫
                    return `<strong class="${voteClass}">${vote}</strong><br/><strong>ÂéüÂõ†Ôºö</strong><br/>${reason}`;
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂàÜÈöîÁ¨¶ÔºåÂ∞ùËØïÊü•Êâæ"ÂéüÂõ†Ôºö"
                    if (formattedContent.includes('ÂéüÂõ†Ôºö')) {
                        const voteMatch = formattedContent.match(/^ÊäïÁ•®Ôºö(ÊîØÊåÅ|ÂèçÂØπ)/);
                        if (voteMatch) {
                            const voteResult = voteMatch[0];
                            const voteClass = voteResult.includes('ÊîØÊåÅ') ? 'support' : 'oppose';
                            const reasonPart = formattedContent.replace(/^ÊäïÁ•®Ôºö(ÊîØÊåÅ|ÂèçÂØπ)<br\/>?/, '');
                            
                            return `<strong class="${voteClass}">${voteResult}</strong><br/>${reasonPart}`;
                        }
                    }
                }
                
                // Â¶ÇÊûúÊ†ºÂºè‰∏çÂåπÈÖçÔºåÁõ¥Êé•ËøîÂõûÊ†ºÂºèÂåñÂêéÁöÑÂÜÖÂÆπ
                return formattedContent;
            }
            
            // ÂØπ‰∫éÂà§ÂÜ≥ÂÜÖÂÆπÔºåÂèØ‰ª•ÁâπÊÆäÊ†ºÂºèÂåñ
            if (messageType === 'verdict') {
                return `<strong>${content}</strong>`;
            }
            
            // Â∞ÜÊç¢Ë°åÁ¨¶ËΩ¨Êç¢‰∏∫HTMLÊç¢Ë°å
            return content.replace(/\n/g, '<br/>');
        }



        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }

        // ÂàùÂßãÂåñ‰∏ªÈ¢òÁÆ°ÁêÜÂô®
        document.addEventListener('DOMContentLoaded', async function() {
            const themeManager = new ThemeManager();
            await themeManager.init();
            
            // Ê∑ªÂä†‰∏ªÈ¢òÈÄâÊã©Âô®
            const themeSelector = document.createElement('div');
            themeSelector.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
            `;
            
            const themeBtn = document.createElement('button');
            themeBtn.textContent = 'üé®';
            themeBtn.title = 'ÂàáÊç¢‰∏ªÈ¢ò';
            themeBtn.style.cssText = `
                background: var(--theme-secondary-bg);
                border: 1px solid var(--theme-border-color);
                color: var(--theme-text-primary);
                padding: 10px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 16px;
                backdrop-filter: blur(10px);
                transition: all 0.3s ease;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            themeBtn.addEventListener('click', () => {
                themeManager.switchToNextTheme();
            });
            
            themeBtn.addEventListener('mouseenter', () => {
                themeBtn.style.background = 'var(--theme-hover-bg)';
                themeBtn.style.borderColor = 'var(--theme-primary-color)';
                themeBtn.style.transform = 'scale(1.1)';
            });
            
            themeBtn.addEventListener('mouseleave', () => {
                themeBtn.style.background = 'var(--theme-secondary-bg)';
                themeBtn.style.borderColor = 'var(--theme-border-color)';
                themeBtn.style.transform = 'scale(1)';
            });
            
            themeSelector.appendChild(themeBtn);
            document.body.appendChild(themeSelector);
        });
    </script>
</body>
</html> 