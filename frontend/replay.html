<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆå›æ”¾ - AIä¾¦æ¢æ¨ç†æ¸¸æˆ</title>
    <script src="/static/js/theme-manager.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: var(--theme-primary-bg);
            min-height: 100vh;
            padding: 20px;
            color: var(--theme-text-primary);
            transition: all 0.3s ease;
        }

        .header {
            background: var(--theme-secondary-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px var(--theme-shadow-color);
            border: 1px solid var(--theme-border-color);
        }

        .header h1 {
            color: var(--theme-text-primary);
            margin-bottom: 10px;
            text-shadow: 0 2px 4px var(--theme-shadow-color);
        }

        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: var(--theme-hover-bg);
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--theme-primary-color);
        }

        .info-label {
            font-weight: bold;
            color: var(--theme-text-secondary);
            font-size: 12px;
            text-transform: uppercase;
        }

        .info-value {
            color: var(--theme-text-primary);
            font-size: 14px;
            margin-top: 2px;
        }







        .conversation-container {
            background: var(--theme-secondary-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--theme-shadow-color);
            border: 1px solid var(--theme-border-color);
            max-height: 60vh;
            overflow-y: auto;
        }

        .conversation-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--theme-border-color);
            opacity: 1;
            transition: all 0.3s ease;
        }

        .conversation-item.player {
            background: var(--theme-info-bg);
            border-left-color: var(--theme-info-color);
        }

        .conversation-item.character {
            background: var(--theme-character-suspect-bg);
            border-left-color: var(--theme-character-suspect-color);
        }

        .conversation-item.system {
            background: var(--theme-badge-accent-bg);
            border-left-color: var(--theme-accent-color);
        }

        .conversation-item.accusation {
            background: var(--theme-warning-bg);
            border-left-color: var(--theme-warning-color);
            font-weight: bold;
        }

        .conversation-item.defense {
            background: var(--theme-success-bg);
            border-left-color: var(--theme-success-color);
        }

        .conversation-item.testimony {
            background: var(--theme-info-bg);
            border-left-color: var(--theme-info-color);
        }

        .conversation-item.vote {
            background: var(--theme-character-witness-bg);
            border-left-color: var(--theme-character-witness-color);
        }

        .conversation-item.verdict {
            background: var(--theme-badge-accent-bg);
            border-left-color: var(--theme-accent-color);
            font-weight: bold;
            font-size: 16px;
        }

        .conversation-item.solution {
            background: var(--theme-success-bg);
            border-left-color: var(--theme-success-color);
            font-style: italic;
        }

        .speaker {
            font-weight: bold;
            color: var(--theme-text-primary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .timestamp {
            font-size: 12px;
            color: var(--theme-text-secondary);
            font-weight: normal;
        }

        .content {
            color: var(--theme-text-primary);
            line-height: 1.6;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--theme-text-secondary);
        }

        .error {
            background: var(--theme-warning-bg);
            color: var(--theme-warning-color);
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
            border: 1px solid var(--theme-warning-color);
        }

        .support {
            color: var(--theme-success-color);
            font-weight: bold;
        }

        .oppose {
            color: var(--theme-warning-color);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¬ æ¸¸æˆå›æ”¾</h1>
        <div id="sessionInfo" class="session-info">
            <!-- ä¼šè¯ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
    </div>



    <div id="evaluationSection" class="header" style="display: none;">
        <h3>ğŸŒŸ æ¸¸æˆè¯„ä»·</h3>
        <div id="evaluationContent">
            <!-- è¯„ä»·å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <div id="loadingDiv" class="loading">
        <p>æ­£åœ¨åŠ è½½å›æ”¾æ•°æ®...</p>
    </div>

    <div id="errorDiv" class="error" style="display: none;">
        <p id="errorMessage">åŠ è½½å¤±è´¥</p>
    </div>

    <div id="conversationContainer" class="conversation-container" style="display: none;">
        <!-- å¯¹è¯å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
    </div>

    <script>
        let replayData = null;
        let appTimezone = 'Asia/Shanghai'; // é»˜è®¤æ—¶åŒº

        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        const sessionId = getUrlParameter('session_id');

        // é¡µé¢åŠ è½½æ—¶è·å–å›æ”¾æ•°æ®
        document.addEventListener('DOMContentLoaded', async function() {
            if (!sessionId) {
                showError('ç¼ºå°‘ä¼šè¯IDï¼Œè¯·ä»ä¼šè¯åˆ—è¡¨ä¸­è¿›å…¥æ­¤é¡µé¢');
                return;
            }
            
            // å…ˆè·å–åº”ç”¨é…ç½®ï¼ˆåŒ…æ‹¬æ—¶åŒºï¼‰
            try {
                const configResponse = await fetch('/api/config');
                if (configResponse.ok) {
                    const config = await configResponse.json();
                    appTimezone = config.timezone;
                }
            } catch (error) {
                console.warn('è·å–åº”ç”¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ—¶åŒº:', error);
            }
            
            loadReplayData();
        });

        // åŠ è½½å›æ”¾æ•°æ®
        async function loadReplayData() {
            try {
                const response = await fetch(`/api/game/${sessionId}/replay`);
                if (!response.ok) {
                    throw new Error('åŠ è½½å›æ”¾æ•°æ®å¤±è´¥');
                }
                
                replayData = await response.json();
                displaySessionInfo();
                displayConversations();
                
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('conversationContainer').style.display = 'block';
                
            } catch (error) {
                console.error('åŠ è½½å›æ”¾æ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½å›æ”¾æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // è®¡ç®—å¯¹è¯è½®æ•°
        function calculateConversationRounds() {
            if (!replayData || !replayData.conversations) return 0;
            
            // è®¡ç®—é—®ç­”å¯¹çš„æ•°é‡
            const questions = replayData.conversations.filter(conv => 
                conv.message_type === 'question' || 
                (conv.speaker_type === 'player' && !conv.message_type)
            );
            
            return questions.length;
        }

        // æ˜¾ç¤ºä¼šè¯ä¿¡æ¯
        function displaySessionInfo() {
            const info = replayData.session_info;
            const container = document.getElementById('sessionInfo');
            
            const startTime = new Date(info.start_time).toLocaleString('zh-CN', { timeZone: appTimezone });
            
            // è®¡ç®—æ¸¸æˆæ—¶é•¿
            let durationText = 'æœªçŸ¥';
            if (info.start_time && info.end_time) {
                const startTimeObj = new Date(info.start_time);
                const endTimeObj = new Date(info.end_time);
                const durationMs = endTimeObj - startTimeObj;
                const minutes = Math.floor(durationMs / (1000 * 60));
                const seconds = Math.floor((durationMs % (1000 * 60)) / 1000);
                
                if (minutes > 0) {
                    durationText = `${minutes}åˆ†${seconds}ç§’`;
                } else {
                    durationText = `${seconds}ç§’`;
                }
            } else if (info.start_time && !info.end_time) {
                durationText = 'è¿›è¡Œä¸­';
            }

            container.innerHTML = `
                <div class="info-item">
                    <div class="info-label">æ¡ˆä»¶æ ‡é¢˜</div>
                    <div class="info-value">${info.case_title}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å¼€å§‹æ—¶é—´</div>
                    <div class="info-value">${startTime}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ¸¸æˆæ—¶é•¿</div>
                    <div class="info-value">${durationText}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å¯¹è¯è½®æ•°</div>
                    <div class="info-value">${calculateConversationRounds()} è½®</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ä½¿ç”¨æç¤º</div>
                    <div class="info-value">${info.hints_used || 0} æ¬¡</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ¸¸æˆçŠ¶æ€</div>
                    <div class="info-value">${info.is_solved ? 'âœ… å·²è§£å†³' : 'âŒ æœªè§£å†³'}</div>
                </div>
                ${info.client_id ? `
                    <div class="info-item">
                        <div class="info-label">å®¢æˆ·ç«¯æ ‡è¯†</div>
                        <div class="info-value" style="font-family: monospace; font-size: 0.9em;">${info.client_id}</div>
                    </div>
                ` : ''}
                ${info.ip_address ? `
                    <div class="info-item">
                        <div class="info-label">IPåœ°å€</div>
                        <div class="info-value">${info.ip_address}</div>
                    </div>
                ` : ''}
                ${info.game_version ? `
                    <div class="info-item">
                        <div class="info-label">æ¸¸æˆç‰ˆæœ¬</div>
                        <div class="info-value">${info.game_version}</div>
                    </div>
                ` : ''}
            `;

            // æ˜¾ç¤ºè¯„ä»·ä¿¡æ¯
            if (replayData.evaluation) {
                displayEvaluation();
            }
        }

        // æ˜¾ç¤ºè¯„ä»·ä¿¡æ¯
        function displayEvaluation() {
            const evaluation = replayData.evaluation;
            const container = document.getElementById('evaluationContent');
            const section = document.getElementById('evaluationSection');
            
            const stars = 'â­'.repeat(evaluation.rating) + 'â˜†'.repeat(5 - evaluation.rating);
            const difficultyMap = {
                'too_easy': 'å¤ªç®€å•',
                'just_right': 'åˆšå¥½',
                'too_hard': 'å¤ªå›°éš¾'
            };
            
            container.innerHTML = `
                <div class="session-info">
                    <div class="info-item">
                        <div class="info-label">è¯„åˆ†</div>
                        <div class="info-value">${stars} (${evaluation.rating}/5)</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è¯„ä»·ç†ç”±</div>
                        <div class="info-value">${evaluation.reason}</div>
                    </div>
                    ${evaluation.difficulty_feedback ? `
                        <div class="info-item">
                            <div class="info-label">éš¾åº¦åé¦ˆ</div>
                            <div class="info-value">${difficultyMap[evaluation.difficulty_feedback] || evaluation.difficulty_feedback}</div>
                        </div>
                    ` : ''}
                    ${evaluation.most_liked ? `
                        <div class="info-item">
                            <div class="info-label">æœ€å–œæ¬¢çš„éƒ¨åˆ†</div>
                            <div class="info-value">${evaluation.most_liked}</div>
                        </div>
                    ` : ''}
                    ${evaluation.suggestions ? `
                        <div class="info-item">
                            <div class="info-label">æ”¹è¿›å»ºè®®</div>
                            <div class="info-value">${evaluation.suggestions}</div>
                        </div>
                    ` : ''}
                    ${evaluation.would_recommend !== null ? `
                        <div class="info-item">
                            <div class="info-label">æ˜¯å¦æ¨è</div>
                            <div class="info-value">${evaluation.would_recommend ? 'âœ… æ˜¯' : 'âŒ å¦'}</div>
                        </div>
                    ` : ''}
                    <div class="info-item">
                        <div class="info-label">è¯„ä»·æ—¶é—´</div>
                        <div class="info-value">${new Date(evaluation.created_at).toLocaleString('zh-CN', { timeZone: appTimezone })}</div>
                    </div>
                </div>
            `;
            
            section.style.display = 'block';
        }

        // æ˜¾ç¤ºå¯¹è¯å†…å®¹
        function displayConversations() {
            const container = document.getElementById('conversationContainer');
            const conversations = replayData.conversations;
            
            container.innerHTML = conversations.map((conv, index) => {
                const speakerName = conv.speaker_name || getSpeakerDisplayName(conv.speaker_type, conv.message_type, conv.extra_data);
                const time = new Date(conv.timestamp).toLocaleString('zh-CN', { timeZone: appTimezone });
                const messageTypeClass = conv.message_type || conv.speaker_type;
                
                return `
                    <div class="conversation-item ${messageTypeClass}" data-index="${index}">
                        <div class="speaker">
                            <span>${getMessageTypeIcon(conv.message_type)} ${speakerName}</span>
                            <span class="timestamp">${time}</span>
                        </div>
                        <div class="content">${formatContent(conv.content, conv.message_type)}</div>
                    </div>
                `;
            }).join('');
        }

        // è·å–å‘è¨€è€…æ˜¾ç¤ºåç§°
        function getSpeakerDisplayName(speakerType, messageType, extraData) {
            if (messageType) {
                const messageTypeNames = {
                    'question': 'ğŸ‘¤ ç©å®¶æé—®',
                    'answer': 'ğŸ­ è§’è‰²å›ç­”',
                    'accusation': 'âš–ï¸ ç©å®¶æŒ‡æ§',
                    'defense': 'ğŸ›¡ï¸ è¢«å‘Šè¾©æŠ¤',
                    'testimony': 'ğŸ‘¥ è¯äººè¯è¯',
                    'vote': 'ğŸ—³ï¸ é™ªå®¡å›¢æŠ•ç¥¨',
                    'verdict': 'âš–ï¸ æœ€ç»ˆåˆ¤å†³',
                    'solution': 'ğŸ” æ¡ˆä»¶çœŸç›¸'
                };
                
                // ç‰¹æ®Šå¤„ç†ç©å®¶æé—®ï¼Œæ˜¾ç¤ºè¢«æé—®çš„è§’è‰²
                if (messageType === 'question' && extraData && extraData.character_target) {
                    return `ğŸ‘¤ ç©å®¶å‘ ${extraData.character_target} æé—®`;
                }
                
                if (messageTypeNames[messageType]) {
                    return messageTypeNames[messageType];
                }
            }
            
            const names = {
                'player': 'ğŸ‘¤ ç©å®¶',
                'character': 'ğŸ­ è§’è‰²',
                'narrator': 'ğŸ“– å™è¿°è€…',
                'system': 'ğŸ–¥ï¸ ç³»ç»Ÿ'
            };
            return names[speakerType] || speakerType;
        }

        // è·å–æ¶ˆæ¯ç±»å‹å›¾æ ‡
        function getMessageTypeIcon(messageType) {
            const icons = {
                'question': 'â“',
                'answer': 'ğŸ’¬',
                'accusation': 'âš–ï¸',
                'defense': 'ğŸ›¡ï¸',
                'testimony': 'ğŸ‘¥',
                'vote': 'ğŸ—³ï¸',
                'verdict': 'âš–ï¸',
                'solution': 'ğŸ”'
            };
            return icons[messageType] || '';
        }

        // æ ¼å¼åŒ–å†…å®¹
        function formatContent(content, messageType) {
            // å¯¹äºæŠ•ç¥¨å†…å®¹ï¼Œç‰¹æ®Šæ ¼å¼åŒ–
            if (messageType === 'vote' && content.includes('æŠ•ç¥¨ï¼š')) {
                // å…ˆå°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œ
                let formattedContent = content.replace(/\n/g, '<br/>');
                
                // æŸ¥æ‰¾æŠ•ç¥¨å’ŒåŸå› çš„åˆ†éš”ç¬¦
                if (formattedContent.includes(' - ')) {
                    const parts = formattedContent.split(' - ');
                    const vote = parts[0];
                    const reason = parts.slice(1).join(' - ');
                    const voteClass = vote.includes('æ”¯æŒ') ? 'support' : 'oppose';
                    
                    // æ ¼å¼åŒ–ï¼šæŠ•ç¥¨ç»“æœåŠ ç²—ï¼ŒåŸå› éƒ¨åˆ†æ¢è¡Œæ˜¾ç¤º
                    return `<strong class="${voteClass}">${vote}</strong><br/><strong>åŸå› ï¼š</strong><br/>${reason}`;
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ†éš”ç¬¦ï¼Œå°è¯•æŸ¥æ‰¾"åŸå› ï¼š"
                    if (formattedContent.includes('åŸå› ï¼š')) {
                        const voteMatch = formattedContent.match(/^æŠ•ç¥¨ï¼š(æ”¯æŒ|åå¯¹)/);
                        if (voteMatch) {
                            const voteResult = voteMatch[0];
                            const voteClass = voteResult.includes('æ”¯æŒ') ? 'support' : 'oppose';
                            const reasonPart = formattedContent.replace(/^æŠ•ç¥¨ï¼š(æ”¯æŒ|åå¯¹)<br\/>?/, '');
                            
                            return `<strong class="${voteClass}">${voteResult}</strong><br/>${reasonPart}`;
                        }
                    }
                }
                
                // å¦‚æœæ ¼å¼ä¸åŒ¹é…ï¼Œç›´æ¥è¿”å›æ ¼å¼åŒ–åçš„å†…å®¹
                return formattedContent;
            }
            
            // å¯¹äºåˆ¤å†³å†…å®¹ï¼Œå¯ä»¥ç‰¹æ®Šæ ¼å¼åŒ–
            if (messageType === 'verdict') {
                return `<strong>${content}</strong>`;
            }
            
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œ
            return content.replace(/\n/g, '<br/>');
        }



        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }

        // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
        document.addEventListener('DOMContentLoaded', async function() {
            const themeManager = new ThemeManager();
            await themeManager.init();
            
            // æ·»åŠ ä¸»é¢˜é€‰æ‹©å™¨
            const themeSelector = document.createElement('div');
            themeSelector.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
            `;
            
            const themeBtn = document.createElement('button');
            themeBtn.textContent = 'ğŸ¨';
            themeBtn.title = 'åˆ‡æ¢ä¸»é¢˜';
            themeBtn.style.cssText = `
                background: var(--theme-secondary-bg);
                border: 1px solid var(--theme-border-color);
                color: var(--theme-text-primary);
                padding: 10px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 16px;
                backdrop-filter: blur(10px);
                transition: all 0.3s ease;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            themeBtn.addEventListener('click', () => {
                themeManager.switchToNextTheme();
            });
            
            themeBtn.addEventListener('mouseenter', () => {
                themeBtn.style.background = 'var(--theme-hover-bg)';
                themeBtn.style.borderColor = 'var(--theme-primary-color)';
                themeBtn.style.transform = 'scale(1.1)';
            });
            
            themeBtn.addEventListener('mouseleave', () => {
                themeBtn.style.background = 'var(--theme-secondary-bg)';
                themeBtn.style.borderColor = 'var(--theme-border-color)';
                themeBtn.style.transform = 'scale(1)';
            });
            
            themeSelector.appendChild(themeBtn);
            document.body.appendChild(themeSelector);
        });
    </script>
</body>
</html> 